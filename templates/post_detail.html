{% load static %}
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }} - Blog</title>
    <link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div>   
        {% include 'navbar.html' %}
    </div>

    <main class="container">
        <article class="post-card">
            <header class="post-header">
                <div class="banner-wrapper">
                    <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}" class="post-banner">
                </div>
            </header>

            <section class="post-body">
                <h1 class="post-title">{{ post.title }}</h1>                
                <div class="post-content">
                    {{ post.content|linebreaks }}
                </div>
                
                <footer class="post-footer">
                    <div class="interaction-container" style="display: flex; gap: 15px; width: 100%; align-items: center;">
                        {% if user.is_authenticated %}
                        <div class="like-section">
                            <form method="post" action="{% url 'blog:like_post' post.id %}" class="like-form">
                                {% csrf_token %}
                                    <button type="submit" class="like-btn" data-liked="{{ user_has_liked|yesno:'true,false' }}">
                                        {% if user_has_liked %}
                                            <i class="fas fa-heart"></i> {% else %}
                                            <i class="far fa-heart"></i> {% endif %}
                                    </button>
                            </form>
                            <span class="like-count">{{ post.likes.count }} Like</span>
                        </div>
                        <div class="favorite-section">
                            <form method="post" action="{% url 'blog:favorite_post' post.id %}" class="favorite-form">
                                {% csrf_token %}
                                    <button type="submit" class="fav-btn" data-favorited="{{ user_has_favorited|yesno:'true,false' }}">
                                        {% if user_has_favorited %}
                                            <i class="fas fa-star"></i> {% else %}
                                            <i class="far fa-star"></i> {% endif %}
                                    </button>
                            </form>
                            <span class="favorite-count">{{ post.favorites.count }} Favorites</span>
                        </div>
                        {% else %}
                        <div class="like-section">
                            <a href="{% url 'blog:login' %}" class="login-prompt">Bəyənmək üçün daxil olun</a>
                            <span class="like-count">{{ post.likes.count }} Like</span>
                        </div>
                        <div class="favorite-section">
                            <a href="{% url 'blog:login' %}" class="login-prompt">Favorite üçün daxil olun</a>
                            <span class="favorite-count">{{ post.favorites.count }} fav</span>
                        </div>
                        {% endif %}
                    </div>

                    <a href="{{ post.link }}" class="cta-button" target="_blank" style="width: 100%; text-align: center; margin-top: 10px;">
                        İzləmək üçün buraya klikləyin
                    </a>
                </footer>
            </section>
        </article>

        <!-- Comments Section -->
        <section class="comments-section">
            <h2 class="comments-title">Şərhlər ({{ post.comment.count }})</h2>
            
            {% if user.is_authenticated %}
            <!-- Comment Form -->
            <div class="comment-form-wrapper">
                <h3>Şərh əlavə et</h3>
                <form method="post" action="{% url 'blog:comment' post.id %}" class="comment-form">
                    {% csrf_token %}
                    <textarea name="content" rows="4" placeholder="Şərhinizi yazın..." required></textarea>
                    <button type="submit" class="submit-comment-btn">
                        <i class="fas fa-paper-plane"></i> Göndər
                    </button>
                </form>
            </div>
            {% else %}
            <div class="login-prompt-comment">
                <p><i class="fas fa-lock"></i> Şərh yazmaq üçün <a href="{% url 'admin:login' %}?next={{ request.path }}">daxil olun</a></p>
            </div>
            {% endif %}

            <!-- Comments List -->
            <div class="comments-list">
                {% for comment in post.comment.all %}
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-user">
                            <i class="fas fa-user-circle"></i>
                            <strong class="comment-author">{{ comment.user.username }}</strong>
                        </div>
                        <span class="comment-date">
                            <i class="far fa-clock"></i> {{ comment.created_at|date:"d.m.Y H:i" }}
                        </span>
                    </div>
                    <div class="comment-content">
                        {{ comment.content|linebreaks }}
                    </div>
                </div>
                {% empty %}
                <div class="no-comments">
                    <i class="far fa-comments"></i>
                    <p>Hələ şərh yoxdur. İlk şərhi siz yazın!</p>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

<script>
const likeForm = document.querySelector('.like-form');
if (likeForm) {
    likeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('.like-btn');
        btn.classList.add('liked');
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = data.liked ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>';
            btn.dataset.liked = data.liked;
            document.querySelector('.like-count').textContent = data.total_likes + ' Like';
        });
    });
}

const favForm = document.querySelector('.favorite-form');
if (favForm) {
    favForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = this.querySelector('.fav-btn');
        btn.classList.add('favorited');
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = data.favorited ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            btn.dataset.favorited = data.favorited;
            document.querySelector('.favorite-count').textContent = data.total_favorites + ' Favorites';
        });
    });
}
</script>

</body>
</html>